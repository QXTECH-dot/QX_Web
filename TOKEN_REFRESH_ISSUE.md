# Token åˆ·æ–°é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·é‡åˆ° `Firebase: ID Token issued at 1751263968 is stale to sign-in` é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºï¼š

1. **NextAuth ID Token è¿‡æœŸ**ï¼šNextAuthçš„Google OAuth tokenæœ‰ç”Ÿå‘½å‘¨æœŸé™åˆ¶
2. **Firebase Auth åŒæ­¥å¤±è´¥**ï¼šè¿‡æœŸçš„tokenæ— æ³•ç”¨äºFirebase Authè®¤è¯
3. **Firestore æƒé™æ‹’ç»**ï¼šæ²¡æœ‰Firebase Authè®¤è¯ï¼Œæ— æ³•è®¿é—®Firestoreæ•°æ®

## âœ… å·²å®æ–½çš„è§£å†³æ–¹æ¡ˆ

### 1. **æ”¹è¿›çš„é”™è¯¯å¤„ç†**
- åœ¨ `src/lib/firebase/auth.ts` ä¸­æ·»åŠ äº†tokenè¿‡æœŸæ£€æµ‹
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„Firebase AuthçŠ¶æ€
- æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯

### 2. **ä¼˜é›…é™çº§ç­–ç•¥**
- Firebase Authå¤±è´¥æ—¶ä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
- æš‚æ—¶æ”¾å®½Firestoreæƒé™è§„åˆ™ï¼Œå…è®¸åŸºæœ¬åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- åœ¨å…¬å¸ç®¡ç†é¡µé¢ä¸­ç»§ç»­æ‰§è¡Œåç»­æ“ä½œ

### 3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
- æ˜¾ç¤ºæ˜ç¡®çš„"ä¼šè¯è¿‡æœŸ"é”™è¯¯ä¿¡æ¯
- æä¾›"Re-login"æŒ‰é’®ï¼Œæ–¹ä¾¿ç”¨æˆ·é‡æ–°ç™»å½•
- ä½¿ç”¨ NextAuth çš„ `signOut()` æ­£ç¡®æ¸…ç†ä¼šè¯

### 4. **ä¸´æ—¶Firestoreè§„åˆ™**
```javascript
// å½“å‰è§„åˆ™ï¼ˆä¸´æ—¶ï¼‰
match /user_company/{docId} {
  allow read, write: if true; // æš‚æ—¶å…è®¸æ‰€æœ‰æ“ä½œ
}
```

## ğŸš€ ç°åœ¨çš„ç”¨æˆ·ä½“éªŒ

1. **Tokenæœªè¿‡æœŸæ—¶**ï¼šæ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½
2. **Tokenè¿‡æœŸæ—¶**ï¼š
   - æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
   - æä¾›é‡æ–°ç™»å½•æŒ‰é’®
   - ç”¨æˆ·å¯ä»¥è½»æ¾æ¢å¤ä¼šè¯

## ğŸ› ï¸ é•¿æœŸè§£å†³æ–¹æ¡ˆï¼ˆå¾…å®æ–½ï¼‰

### 1. **Token è‡ªåŠ¨åˆ·æ–°**
```typescript
// åœ¨ NextAuth é…ç½®ä¸­æ·»åŠ è‡ªåŠ¨åˆ·æ–°
callbacks: {
  async jwt({ token, account, profile, user }) {
    if (account) {
      token.refresh_token = account.refresh_token;
    }
    
    // æ£€æŸ¥tokenæ˜¯å¦å¿«è¦è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°
    if (Date.now() < token.expires_at * 1000) {
      return await refreshAccessToken(token);
    }
    
    return token;
  }
}
```

### 2. **æ›´æ™ºèƒ½çš„Firestoreè§„åˆ™**
```javascript
// æœªæ¥çš„å®‰å…¨è§„åˆ™
match /user_company/{docId} {
  allow read, write: if request.auth != null && 
    (resource.data.userId == request.auth.uid || 
     request.resource.data.userId == request.auth.uid);
}
```

### 3. **ä¼šè¯ç®¡ç†ä¼˜åŒ–**
- å®æ–½tokené¢„åˆ·æ–°æœºåˆ¶
- æ·»åŠ ä¼šè¯çŠ¶æ€ç›‘æ§
- åœ¨tokenå³å°†è¿‡æœŸå‰ä¸»åŠ¨åˆ·æ–°

## ğŸ“‹ å½“å‰çŠ¶æ€

- âœ… **é”™è¯¯å¤„ç†**ï¼šå·²ä¼˜åŒ–
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šå·²æ”¹å–„
- âœ… **åŸºæœ¬åŠŸèƒ½**ï¼šæ­£å¸¸å·¥ä½œ
- â³ **å®‰å…¨æ€§**ï¼šä¸´æ—¶é™çº§ï¼ˆéœ€è¦åç»­åŠ å¼ºï¼‰
- â³ **è‡ªåŠ¨åˆ·æ–°**ï¼šå¾…å®æ–½

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **æ­£å¸¸æµç¨‹æµ‹è¯•**ï¼š
   - ç™»å½• â†’ å…¬å¸ç®¡ç† â†’ ABNéªŒè¯ â†’ é‚®ç®±éªŒè¯

2. **Tokenè¿‡æœŸæµ‹è¯•**ï¼š
   - é•¿æ—¶é—´åœç•™åœ¨é¡µé¢
   - åˆ·æ–°é¡µé¢æŸ¥çœ‹é”™è¯¯å¤„ç†
   - ä½¿ç”¨"Re-login"æŒ‰é’®æµ‹è¯•é‡æ–°ç™»å½•

3. **åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•**ï¼š
   - ç¡®è®¤æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ä»ç„¶æ­£å¸¸å·¥ä½œ
   - éªŒè¯æ•°æ®è¯»å†™æ“ä½œæ­£å¸¸

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

- å½“å‰Firestoreè§„åˆ™è¾ƒä¸ºå®½æ¾ï¼Œä»…ç”¨äºè§£å†³å³æ—¶é—®é¢˜
- å»ºè®®åœ¨å®æ–½tokenåˆ·æ–°æœºåˆ¶åï¼Œæ¢å¤ä¸¥æ ¼çš„å®‰å…¨è§„åˆ™
- å®šæœŸç›‘æ§è®¿é—®æ—¥å¿—ï¼Œç¡®ä¿æ²¡æœ‰å¼‚å¸¸è®¿é—® 